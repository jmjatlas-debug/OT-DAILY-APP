<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Daily Note Builder - Standalone</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        /* Prevent layout shift during icon loading */
        .icon-wrapper {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 0;
        }

        /* Smooth transitions */
        .transition-all {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        /**
         * Optimized Icon Component for Standalone HTML
         * Uses the standard Lucide data-attribute method which is more reliable across environments.
         */
        const Icon = ({ name, size = 18, className = "" }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    // Update the data attribute
                    iconRef.current.setAttribute('data-lucide', name);
                    // Trigger the replacement
                    window.lucide.createIcons({
                        attrs: {
                            width: size,
                            height: size,
                            class: className,
                            'stroke-width': 2
                        }
                    });
                }
            }, [name, size, className]);

            // We use a key based on name to force a re-render/replacement if the icon name changes
            return (
                <span 
                    key={name}
                    ref={iconRef} 
                    data-lucide={name} 
                    className={`icon-wrapper ${className}`}
                    style={{ width: size, height: size }}
                ></span>
            );
        };

        const App = () => {
            // Initial Roster
            const DEFAULT_ROSTER = [
                { id: '1', name: 'Avery', goals: ['Fine motor', 'Bilateral integration', 'Energy regulation'] },
                { id: '2', name: 'Cassius', goals: ['Graphomotor', 'Cutting', 'Puzzle skills'] },
                { id: '3', name: 'Leah', goals: ['Working memory', 'Fine motor', 'Visual spatial'] }
            ];

            const [students, setStudents] = useState(() => {
                try {
                    const saved = localStorage.getItem('ot_students_standalone');
                    return saved ? JSON.parse(saved) : DEFAULT_ROSTER;
                } catch (e) {
                    return DEFAULT_ROSTER;
                }
            });

            const [sessions, setSessions] = useState([]);
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeTab, setActiveTab] = useState('build');
            const [searchQuery, setSearchQuery] = useState('');
            const [showCopyToast, setShowCopyToast] = useState(false);

            const AREAS = [
                'Fine motor skills', 'Graphomotor skills', 'Bilateral integration', 
                'Visual motor integration', 'Visual spatial skills', 'Sensory regulation',
                'Body awareness', 'Self regulation', 'Executive functioning'
            ];
            
            const ACTIVITIES = [
                'Theraputty activity', 'Paper tearing craft', 'Weaving project',
                'Letter writing practice', 'Grid drawing activity', 'Color/cut/paste activity',
                'Word search', 'Near point copying', 'Yoga activity'
            ];

            useEffect(() => {
                localStorage.setItem('ot_students_standalone', JSON.stringify(students));
            }, [students]);

            const addSession = (student) => {
                const newSession = {
                    id: Math.random().toString(36).substr(2, 9),
                    studentId: student.id || 'unknown',
                    studentName: student.name || 'Student',
                    status: 'seen',
                    setting: 'individually',
                    location: 'therapy room',
                    areas: [...(student.goals || [])],
                    activities: [],
                    observations: '',
                    effort: 'Good effort',
                    manualNote: null,
                };
                setSessions(prev => [...prev, newSession]);
            };

            const removeSession = (id) => {
                setSessions(prev => prev.filter(s => s.id !== id));
            };

            const updateSession = (id, field, value) => {
                setSessions(prev => prev.map(s => {
                    if (s.id === id) {
                        const updated = { ...s, [field]: value };
                        // Reset manual note if core data changes, but not if editing note itself
                        if (field !== 'manualNote') {
                            updated.manualNote = null;
                        }
                        return updated;
                    }
                    return s;
                }));
            };

            const generateNoteText = (s) => {
                if (!s) return "";
                if (s.status === 'absent') return `${s.studentName || 'Student'} was absent for today's scheduled session.`;
                if (s.status === 'not-available') return `${s.studentName || 'Student'} was not available for therapy at the scheduled time.`;
                
                const areaPart = s.areas && s.areas.length > 0 
                    ? ` to address ${s.areas.join(', ')}` 
                    : '';
                
                const activityPart = s.activities && s.activities.length > 0 
                    ? ` ${s.studentName} participated in ${s.activities.join(' and ')}.` 
                    : '';
                
                const obsPart = s.observations ? ` ${s.observations}` : '';
                const effortPart = s.effort ? ` ${s.studentName} demonstrated ${s.effort.toLowerCase()} throughout the session.` : '';
                
                return `${s.studentName || 'Student'} was seen ${s.setting || 'individually'} in the ${s.location || 'therapy room'} today${areaPart}.${activityPart}${obsPart}${effortPart}`.trim();
            };

            const copyAllToClipboard = () => {
                const formattedDate = new Date(selectedDate).toLocaleDateString('en-US');
                const allNotes = sessions.map(s => s.manualNote || generateNoteText(s)).join('\n\n');
                const finalContent = `Date: ${formattedDate}\n\n${allNotes}`;
                
                const textArea = document.createElement("textarea");
                textArea.value = finalContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                setShowCopyToast(true);
                setTimeout(() => setShowCopyToast(false), 2000);
            };

            const filteredStudents = useMemo(() => {
                return students.filter(s => 
                    (s.name || '').toLowerCase().includes(searchQuery.toLowerCase())
                );
            }, [students, searchQuery]);

            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-40 px-4 py-4 shadow-sm">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-100">
                                    <Icon name="ClipboardList" className="text-white" size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-black text-slate-800 tracking-tight">OT Note Builder</h1>
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">Standalone Documentation</p>
                                </div>
                            </div>
                            
                            <div className="flex gap-3 items-center w-full md:w-auto">
                                <input 
                                    type="date" 
                                    value={selectedDate}
                                    onChange={(e) => setSelectedDate(e.target.value)}
                                    className="px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none"
                                />
                                <button 
                                    onClick={copyAllToClipboard}
                                    disabled={sessions.length === 0}
                                    className="flex-1 md:flex-none bg-slate-900 hover:bg-black text-white px-6 py-2 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-md active:scale-95 disabled:opacity-30"
                                >
                                    <Icon name="Copy" size={18} /> Copy All
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 flex flex-col lg:flex-row gap-8 mt-6">
                        {/* Sidebar */}
                        <aside className="w-full lg:w-72 flex flex-col gap-4">
                            <div className="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="font-black text-slate-700 text-sm uppercase tracking-wider flex items-center gap-2">
                                        <Icon name="Users" size={16} className="text-blue-500" /> Roster
                                    </h2>
                                    <button 
                                        onClick={() => setActiveTab('students')}
                                        className="text-[10px] font-black text-blue-600 hover:underline uppercase"
                                    >
                                        Edit
                                    </button>
                                </div>
                                
                                <div className="relative mb-4">
                                    <Icon name="Search" size={14} className="absolute left-3 top-3 text-slate-400" />
                                    <input 
                                        type="text"
                                        placeholder="Find student..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="w-full pl-9 pr-4 py-2.5 bg-slate-50 border border-transparent rounded-2xl text-sm focus:bg-white focus:border-blue-200 outline-none transition-all"
                                    />
                                </div>

                                <div className="space-y-1 max-h-[50vh] overflow-y-auto custom-scrollbar pr-1">
                                    {filteredStudents.map(student => (
                                        <button
                                            key={student.id}
                                            onClick={() => addSession(student)}
                                            className="w-full text-left p-3 rounded-2xl hover:bg-blue-50 group transition-all flex justify-between items-center border border-transparent hover:border-blue-100"
                                        >
                                            <div className="truncate">
                                                <div className="font-bold text-slate-800 group-hover:text-blue-700">{student.name || 'Unnamed'}</div>
                                                <div className="text-[10px] text-slate-400 uppercase font-bold tracking-tighter truncate">
                                                    {(student.goals || []).join(' â€¢ ') || 'No Goals'}
                                                </div>
                                            </div>
                                            <Icon name="PlusCircle" size={18} className="text-slate-200 group-hover:text-blue-500" />
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </aside>

                        {/* Editor Area */}
                        <section className="flex-1 space-y-6">
                            {sessions.length === 0 ? (
                                <div className="bg-white border-2 border-dashed border-slate-200 rounded-[3rem] h-96 flex flex-col items-center justify-center text-center p-10">
                                    <div className="bg-slate-50 p-6 rounded-full mb-4">
                                        <Icon name="FilePlus" size={40} className="text-slate-200" />
                                    </div>
                                    <h3 className="text-xl font-black text-slate-800">Ready to build?</h3>
                                    <p className="text-slate-400 text-sm mt-2 max-w-xs">Select a student from the roster to generate a professional therapy note.</p>
                                </div>
                            ) : (
                                sessions.map((session) => (
                                    <div key={session.id} className="bg-white border border-slate-200 rounded-[2.5rem] shadow-sm overflow-hidden animate-in fade-in zoom-in duration-300">
                                        {/* Card Header */}
                                        <div className="bg-white border-b border-slate-100 px-8 py-5 flex flex-wrap justify-between items-center gap-4">
                                            <div className="flex items-center gap-4">
                                                <h3 className="text-xl font-black text-slate-800">{session.studentName}</h3>
                                                <div className="flex bg-slate-100 rounded-xl p-1 gap-1">
                                                    {['seen', 'absent', 'not-available'].map(st => (
                                                        <button
                                                            key={st}
                                                            onClick={() => updateSession(session.id, 'status', st)}
                                                            className={`px-3 py-1.5 text-[10px] uppercase font-black rounded-lg transition-all ${session.status === st ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                                        >
                                                            {st.replace('-', ' ')}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            <button onClick={() => removeSession(session.id)} className="text-slate-300 hover:text-red-500 transition-colors">
                                                <Icon name="XCircle" size={24} />
                                            </button>
                                        </div>

                                        {session.status === 'seen' && (
                                            <div className="p-8 space-y-8">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                                    <div className="space-y-6">
                                                        <div>
                                                            <label className="text-[10px] uppercase font-black text-slate-400 mb-2 block tracking-widest">Setting & Location</label>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                <select 
                                                                    className="px-3 py-2.5 bg-slate-50 border border-slate-100 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-100"
                                                                    value={session.setting}
                                                                    onChange={(e) => updateSession(session.id, 'setting', e.target.value)}
                                                                >
                                                                    <option value="individually">Individually</option>
                                                                    <option value="in a small group">Group</option>
                                                                    <option value="with a peer">With Peer</option>
                                                                </select>
                                                                <select 
                                                                    className="px-3 py-2.5 bg-slate-50 border border-slate-100 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-100"
                                                                    value={session.location}
                                                                    onChange={(e) => updateSession(session.id, 'location', e.target.value)}
                                                                >
                                                                    <option value="therapy room">Therapy Room</option>
                                                                    <option value="classroom">Classroom</option>
                                                                    <option value="cafeteria">Cafeteria</option>
                                                                </select>
                                                            </div>
                                                        </div>

                                                        <div>
                                                            <label className="text-[10px] uppercase font-black text-slate-400 mb-2 block tracking-widest">Observations</label>
                                                            <textarea 
                                                                className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm h-32 outline-none focus:ring-2 focus:ring-blue-100 resize-none font-medium"
                                                                placeholder="Type specific observations..."
                                                                value={session.observations || ''}
                                                                onChange={(e) => updateSession(session.id, 'observations', e.target.value)}
                                                            />
                                                        </div>
                                                    </div>

                                                    <div className="space-y-6">
                                                        <div>
                                                            <label className="text-[10px] uppercase font-black text-slate-400 mb-2 block tracking-widest">Focus Areas</label>
                                                            <div className="flex flex-wrap gap-1.5">
                                                                {AREAS.map(area => (
                                                                    <button
                                                                        key={area}
                                                                        onClick={() => {
                                                                            const exists = (session.areas || []).includes(area);
                                                                            updateSession(session.id, 'areas', exists ? session.areas.filter(a => a !== area) : [...(session.areas || []), area]);
                                                                        }}
                                                                        className={`px-3 py-1.5 rounded-lg text-[10px] font-black border transition-all ${session.areas.includes(area) ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}
                                                                    >
                                                                        {area}
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label className="text-[10px] uppercase font-black text-slate-400 mb-2 block tracking-widest">Activities</label>
                                                            <div className="flex flex-wrap gap-1.5">
                                                                {ACTIVITIES.map(act => (
                                                                    <button
                                                                        key={act}
                                                                        onClick={() => {
                                                                            const exists = (session.activities || []).includes(act);
                                                                            updateSession(session.id, 'activities', exists ? session.activities.filter(a => a !== act) : [...(session.activities || []), act]);
                                                                        }}
                                                                        className={`px-3 py-1.5 rounded-lg text-[10px] font-black border transition-all ${session.activities.includes(act) ? 'bg-emerald-600 border-emerald-600 text-white' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}
                                                                    >
                                                                        {act}
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="text-[10px] uppercase font-black text-slate-400 mb-3 block tracking-widest">Session Effort</label>
                                                    <div className="grid grid-cols-4 gap-2">
                                                        {['Excellent effort', 'Good effort', 'Fair effort', 'Poor effort'].map(eff => (
                                                            <button
                                                                key={eff}
                                                                onClick={() => updateSession(session.id, 'effort', eff)}
                                                                className={`py-3 text-[10px] font-black rounded-xl border transition-all uppercase ${session.effort === eff ? 'bg-slate-900 border-slate-900 text-white shadow-lg' : 'bg-white border-slate-200 text-slate-400 hover:bg-slate-50'}`}
                                                            >
                                                                {eff.split(' ')[0]}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Preview / Editable Note */}
                                        <div className="bg-blue-50/50 p-8 border-t border-blue-100/50">
                                            <div className="flex justify-between items-center mb-4">
                                                <div className="flex items-center gap-2">
                                                    <Icon name="FileText" size={16} className="text-blue-500" />
                                                    <span className="text-[10px] font-black text-blue-500 uppercase tracking-widest">Editable Clinical Note</span>
                                                    {session.manualNote !== null && <span className="bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full text-[9px] font-black">EDITED</span>}
                                                </div>
                                                {session.manualNote !== null && (
                                                    <button 
                                                        onClick={() => updateSession(session.id, 'manualNote', null)}
                                                        className="text-[10px] font-black text-slate-400 hover:text-blue-600 transition-colors uppercase tracking-tight underline underline-offset-4"
                                                    >
                                                        Reset to Auto
                                                    </button>
                                                )}
                                            </div>
                                            <textarea 
                                                className="w-full bg-white border-none rounded-[1.5rem] p-6 text-sm text-slate-600 leading-relaxed font-medium italic shadow-inner outline-none focus:ring-4 focus:ring-blue-100 transition-all min-h-[120px]"
                                                value={session.manualNote !== null ? session.manualNote : generateNoteText(session)}
                                                onChange={(e) => updateSession(session.id, 'manualNote', e.target.value)}
                                            />
                                        </div>
                                    </div>
                                ))
                            )}
                        </section>
                    </main>

                    {/* Manage Students Modal */}
                    {activeTab === 'students' && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-xl rounded-[2.5rem] shadow-2xl overflow-hidden animate-in zoom-in duration-200">
                                <div className="px-8 py-6 border-b border-slate-100 flex justify-between items-center">
                                    <div>
                                        <h3 className="font-black text-xl text-slate-800">Edit Roster</h3>
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Manage names and IEP goals</p>
                                    </div>
                                    <button onClick={() => setActiveTab('build')} className="p-2 hover:bg-slate-100 rounded-full transition-colors">
                                        <Icon name="X" size={24} className="text-slate-400" />
                                    </button>
                                </div>
                                <div className="p-8 space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
                                    {students.map((student, idx) => (
                                        <div key={student.id} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex gap-4 items-start group">
                                            <div className="flex-1 space-y-3">
                                                <input 
                                                    className="w-full font-black text-slate-800 bg-transparent border-none p-0 focus:ring-0 text-base"
                                                    value={student.name || ''}
                                                    placeholder="Student Name"
                                                    onChange={(e) => {
                                                        const newList = [...students];
                                                        newList[idx].name = e.target.value;
                                                        setStudents(newList);
                                                    }}
                                                />
                                                <input 
                                                    className="w-full text-xs font-bold text-slate-400 bg-transparent border-none p-0 focus:ring-0 focus:text-slate-600"
                                                    value={(student.goals || []).join(', ')}
                                                    placeholder="Focus areas (comma separated)"
                                                    onChange={(e) => {
                                                        const newList = [...students];
                                                        newList[idx].goals = e.target.value.split(',').map(s => s.trim());
                                                        setStudents(newList);
                                                    }}
                                                />
                                            </div>
                                            <button 
                                                onClick={() => setStudents(students.filter(s => s.id !== student.id))}
                                                className="p-2 text-slate-200 hover:text-red-500 transition-colors"
                                            >
                                                <Icon name="Trash2" size={18} />
                                            </button>
                                        </div>
                                    ))}
                                    <button 
                                        onClick={() => setStudents([...students, { id: Math.random().toString(), name: '', goals: [] }])}
                                        className="w-full py-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-xs uppercase tracking-widest hover:border-blue-400 hover:text-blue-500 transition-all flex items-center justify-center gap-2"
                                    >
                                        <Icon name="PlusCircle" size={16} /> Add Student
                                    </button>
                                </div>
                                <div className="px-8 py-6 bg-slate-50 border-t border-slate-100 flex justify-end">
                                    <button 
                                        onClick={() => setActiveTab('build')}
                                        className="bg-blue-600 text-white px-10 py-3 rounded-2xl font-black text-sm uppercase tracking-widest shadow-lg shadow-blue-100 hover:bg-blue-700 active:scale-95 transition-all"
                                    >
                                        Finish Editing
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Toast Notification */}
                    {showCopyToast && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-full flex items-center gap-3 shadow-2xl animate-bounce z-[100]">
                            <Icon name="CheckCircle" size={20} className="text-emerald-400" />
                            <span className="font-black text-xs uppercase tracking-widest">Copied All Notes</span>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>